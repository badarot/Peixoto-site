<!DOCTYPE html>
<body>
  
  <div class="title-row" id="agenda_titulo">
    <h1>Teste</h1>
  </div>

  <table class="table-ativar">
    <tr>
      <td>Refletores</td>
      <td>
        <label class="switch" id="switch_refletor">
          <input type="checkbox">
          <span class="slider round"></span>
        </label>
      </td>
    </tr>

    <tr>
      <td>Aerador</td>
      <td>
        <label class="switch" id="switch_aerador">
          <input type="checkbox">
          <span class="slider round"></span>
        </label>
      </td>
    </tr>

    <tr>
      <td>Tratador</td>
      <td>
        <label class="switch" id="switch_tratador">
          <input type="checkbox">
          <span class="slider round"></span>
        </label>
      </td>
    </tr>

    <tr>
      <td>Teste</td>
      <td>
        <label class="switch" id="switch_teste">
          <input type="checkbox">
          <span class="slider round"></span>
        </label>
      </td>
    </tr>

  </table>

  <script type="text/javascript">

    $(document).ready(function(){
      function switch_atualizar(payload) {
        msg = JSON.parse(payload)
        console.log(msg)
        // formato da msg = {'tratador': true, 'aerador': true, 'aerador_tempo': 1:20, ...}
        for (var key in msg) {
          var el = document.getElementById("switch_" + key);
          if (el) {
            el = el.getElementsByTagName('input')[0];
            el.checked = msg[key];
          }
        }
      }
      get_status('estado').then(
          function(msg) {
            switch_atualizar(msg);
          }, function(erro) {
            console.log('erro ao tentar obter status atual: ', erro);
          }
        );
      
      connection.session.subscribe('com.' + dispositivo + '.componentes', switch_atualizar).then(
          function (sub) {log('Inscrito no tópico componentes');},
          function (err) {log('Falha ao se inscrever no tópico componentes', err);}
      );

      //captura clicks nos interruptores
      $(".switch").click(function(event){
        //impede a mudança de estado dos imterruptores
        event.preventDefault();
        event.stopPropagation();
        
        // Se clicado mostra uma janela de confirmaçao antes de enviar
        // a ativaçao do atuador
        var id = $(this).attr('id');
        var interruptor = document.getElementById(id).getElementsByTagName('input')[0];
        var atuador = id.substring(id.lastIndexOf('_') + 1);
        var data = {};
        data[atuador] = !interruptor.checked;

        var acao = 'DESLIGAR';
        if (data[atuador]) acao = 'LIGAR';        
        if (confirm('Deseja ' + acao + ' o ' + atuador + '?')) {

          data = JSON.stringify(data);
          
          var resposta = null;
          ativar(data).then(
            function (msg) { 
              resposta = JSON.parse(msg); 
              switch_atualizar(resposta);
            }, 
            function (erro) { console.log('erro ao receber resposta do interruptor: ', erro); }
          );
          
        }
      });
    });

  </script>
</body>